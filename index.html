<!DOCTYPE html>
<html lang="en">
	<body>
		<div id="root"></div>
		<link href="/index.css" rel="stylesheet" type="text/css" />
		<script src="https://unpkg.com/react@16.12.0/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@16.12.0/umd/react-dom.development.js"></script>
		<script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>
		<script src="https://unpkg.com/axios@0.27.2/dist/axios.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<script type="text/babel">
			function Main() {
				console.log('Main called');
				const [containers, setContainers] = React.useState([]);
				const [files, setFiles] = React.useState({});
				const [config, setConfig] = React.useState();
				const [payload, setPayload] = React.useState(config);

				// Initial fetch of the config.
				React.useEffect(() => {
					fetch(`/config.json`)
						.then((res) => res.json())
						.then(({ config }) => setConfig(config ?? []));
				}, []);

				// Initial fetch of files list as a JSON.
				React.useEffect(() => {
					fetch(`/getfiles`)
						.then((res) => res.json())
						.then((json) => setFiles(json));
				}, []);

				React.useEffect(() => {
					setPayload(config);
				}, [config]);

				// // Fields change handler.
				// function handleChange(event) {
				// 	// return;
				// 	// Figuring what type of field had changed.
				// 	const prop = event.target.attributes.variable.value;
				// 	// Getting index of the changed field.
				// 	const index = event.target.parentElement.attributes.index.value;

				// 	if (prop === 'time') {
				// 		const time = event.target.value;
				// 		if (time === '24' || time < 0) {
				// 			event.target.value = 0;
				// 		} else if (time > 23) {
				// 			event.target.value = 23;
				// 		}
				// 	}

				// 	// Applying changes to config
				// 	const newPayload = [...payload];
				// 	newPayload[index][prop] = event.target.value;
				// 	// setPayload(newPayload);
				// 	console.log(payload);
				// }

				// Save button handler, sends updated config to the server to overwrite existing.
				function handleSubmit() {
					fetch('/config.json', { method: 'POST', body: JSON.stringify({ config: config }) });
				}

				// Getting fresh filenames from images folder.
				function handleUpdate() {
					fetch(`/getfiles`)
						.then((res) => res.json())
						.then((json) => {
							// If no new files were found - there's no reason to re-render.
							// Overwriting the files state only if contents of images folder had changed.
							if (!(JSON.stringify(files) === JSON.stringify(json))) {
								setFiles(json);
							}
						});
				}

				// Sorting
				function handleSort() {
					if (payload.length < 2) return;
					const newConfig = [...payload];

					const sortable = newConfig.sort((a, b) => a.time - b.time);
					setConfig(sortable);
				}

				// Options component, returns an array of <option> values.
				function Options() {
					return Object.keys(files).map((key, index) => {
						return (
							<option key={index} value={key}>
								{key}
							</option>
						);
					});
				}

				// Main Table component, returns the table with content from fetched config.
				function Table() {
					console.log('Table Called.');
					// If there's no config - means we still didn't get a response. Returning a Loading message.
					if (!config) return 'Loading...';
					// If config is empty - returning a starting message.
					if (config?.length < 1) return 'Start by pressing + button below to add a new field.';

					// Fields change handler.
					function handleChange(event) {
						// return;
						// Figuring what type of field had changed.
						const prop = event.target.attributes.variable.value;
						// Getting index of the changed field.
						const index = event.target.parentElement.attributes.index.value;

						if (prop === 'time') {
							const time = event.target.value;
							if (time === '24' || time < 0) {
								event.target.value = 0;
							} else if (time > 23) {
								event.target.value = 23;
							}
						}

						// Applying changes to config
						const newPayload = [...payload];
						newPayload[index][prop] = event.target.value;
						// setPayload(newPayload);
						console.log(payload);
					}

					// Returning an array of containers with fields.
					return config.map((entry, index) => {
						return (
							<div className='gradient' key={index} index={index}>
								<input
									type='text'
									className='gradient'
									variable='name'
									placeholder='Name'
									onChange={handleChange}
									defaultValue={entry.name}></input>
								<input
									type='number'
									className='gradient'
									variable='time'
									placeholder='Time (0-23)'
									onBlur={handleSort}
									onChange={handleChange}
									defaultValue={entry.time}></input>
								<select className='gradient' variable='file' defaultValue={entry.file} onClick={handleUpdate} onChange={handleChange}>
									<option value={0}>Choose a file</option>
									<Options />
								</select>
							</div>
						);
					});
				}

				// Container adding function. Adds an entry to the config.
				function addField() {
					const temp = [...config];
					temp.push({});
					setConfig(temp);
				}

				function Test() {
					console.log('called');
					return <input type='number' onChange={handleTest}></input>;
				}

				function handleTest(event) {
					// event.target.value = 'bruh';
					if (event.target.value > 23) {
						event.target.value = 23;
					}
				}

				return (
					<div>
						<div id='table-container'>
							<Table />
							<Test />
							<div>
								<svg className='plus-button' onClick={() => addField()} viewBox='0 0 490 490'>
									<g>
										<path
											d='M227.8,174.1v53.7h-53.7c-9.5,0-17.2,7.7-17.2,17.2s7.7,17.2,17.2,17.2h53.7v53.7c0,9.5,7.7,17.2,17.2,17.2
												s17.1-7.7,17.1-17.2v-53.7h53.7c9.5,0,17.2-7.7,17.2-17.2s-7.7-17.2-17.2-17.2h-53.7v-53.7c0-9.5-7.7-17.2-17.1-17.2
												S227.8,164.6,227.8,174.1z'
										/>
										<path
											d='M71.7,71.7C25.5,118,0,179.5,0,245s25.5,127,71.8,173.3C118,464.5,179.6,490,245,490s127-25.5,173.3-71.8
												C464.5,372,490,310.4,490,245s-25.5-127-71.8-173.3C372,25.5,310.5,0,245,0C179.6,0,118,25.5,71.7,71.7z M455.7,245
												c0,56.3-21.9,109.2-61.7,149s-92.7,61.7-149,61.7S135.8,433.8,96,394s-61.7-92.7-61.7-149S56.2,135.8,96,96s92.7-61.7,149-61.7
												S354.2,56.2,394,96S455.7,188.7,455.7,245z'
										/>
									</g>
								</svg>
							</div>
						</div>
						<button type='submit' onClick={handleSubmit}>
							Save
						</button>
					</div>
				);
			}

			ReactDOM.render(<Main />, root);
		</script>
	</body>
</html>
