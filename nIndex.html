<!DOCTYPE html>
<html lang="en">
	<body>
		<div id="root"></div>
		<link href="/index.css" rel="stylesheet" type="text/css" />
		<script src="https://unpkg.com/react@16.12.0/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@16.12.0/umd/react-dom.development.js"></script>
		<script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>
		<script src="https://unpkg.com/axios@0.27.2/dist/axios.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<script type="text/babel">
			function App() {
				console.log('App called');
				const [config, setConfig] = React.useState();
				const [files, setFiles] = React.useState();

				React.useEffect(() => {
					fetch(`/config.json`)
						.then((res) => res.json())
						.then(({ config }) => setConfig(config ?? []));
					updateFiles(setFiles);
				}, []);

				return (
					<div>
						<Table conf={[config, setConfig]} fils={[files, setFiles]} />
					</div>
				);
			}

			function Table({ conf, fils }) {
				const [config, setConfig] = conf;
				const [files, setFiles] = fils;
				console.log('Table Called...');
				if (!config) return 'Loading Config...';
				if (!files) return 'Loading Files...';

				if (config.length < 1) return 'Start by adding a field';

				function handleChange() {
					const prop = event.target.attributes.variable.value;
					const index = event.target.parentElement.attributes.index.value;

					if (prop === 'time') {
						var time = event.target.value;

						if (isNaN(time)) {
							time = time.replaceAll(/[^\d]+/g, '');
							event.target.value = time;
						}

						if (time.length > 2) {
							event.target.value = time.slice(1, 3);
						}
						if (time === '24' || time < 0) {
							event.target.value = 0;
						} else if (time > 23) {
							event.target.value = 23;
						}
					}

					const newConfig = [...config];
					newConfig[index][prop] = event.target.value;
					setConfig(newConfig);
					console.log(config);
				}

				return config.map((entry, index) => {
					return (
						<div key={index} index={index}>
							<input type='text' variable='name' placeholder='Name' defaultValue={entry.name} onChange={handleChange}></input>
							<input type='text' variable='time' placeholder='Time' defaultValue={entry.time} onChange={handleChange}></input>
							<select variable='file' defaultValue={entry.file} onClick={() => updateFiles(setFiles)} onChange={handleChange}>
								<option value={0}>Choose a file</option>
								<Options files={files} />
							</select>
						</div>
					);
				});
			}

			const Options = React.memo(function Options({ files }) {
				return Object.keys(files).map((key, index) => {
					return (
						<option key={index} value={key}>
							{key}
						</option>
					);
				});
			});

			function updateFiles(setFiles) {
				console.log(setFiles);
				fetch(`/getfiles`)
					.then((res) => res.json())
					.then((json) => setFiles(json ?? []));
			}

			ReactDOM.render(<App />, root);
		</script>
	</body>
</html>
